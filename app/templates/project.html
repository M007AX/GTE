{% extends "base.html" %}

{% block title %}Проект{% endblock %}

{% block content %}
<div class="project-container">
    <h1>Прогноз на {{ date_info.date }}</h1>

    <div class="weather-controls">
        <a href="{{ url_for('auth.project') }}" class="btn btn-refresh">Обновить данные</a>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-logout">Выйти</a>
        <button id="save-changes" class="btn btn-save">Сохранить изменения</button>
    </div>

    <div class="table-container">
        <table class="weather-table">
            <thead>
                <tr>
                    <th class="sticky-column">Час</th>
                    <th style="background-color: #f2f2f2">День недели</th>
                    <th style="background-color: #f2f2f2">Неделя года</th>
                    <th style="background-color: #f2f2f2">Рабочий день</th>
                    {% for location in locations %}
                    <th colspan="4" style="background-color: {{ location.color }}">{{ location.name }}<br>({{ location.coords[0]|round(4) }}°N, {{ location.coords[1]|round(4) }}°E)</th>
                    {% endfor %}
                </tr>
                <tr>
                    <th class="sticky-column"></th>
                    <th style="background-color: #f2f2f2"></th>
                    <th style="background-color: #f2f2f2"></th>
                    <th style="background-color: #f2f2f2"></th>
                    {% for location in locations %}
                    <th style="background-color: {{ location.color }}">Температура (°C)</th>
                    <th style="background-color: {{ location.color }}">Влажность (%)</th>
                    <th style="background-color: {{ location.color }}">Давление (гПа)</th>
                    <th style="background-color: {{ location.color }}">Скорость ветра (м/с)</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour in range(24) %}
                <tr>
                    <td class="sticky-column">{{ "%02d:00" % hour }}-{{ "%02d:00" % (hour+1) if hour < 23 else "00:00" }}</td>
                    <td style="background-color: #f2f2f2">{{ date_info.day_of_week }}</td>
                    <td style="background-color: #f2f2f2">{{ date_info.week_of_year }}</td>
                    <td style="background-color: #f2f2f2">
                        <select class="editable-workday" data-hour="{{ "%02d:00" % hour }}" style="width: 100%">
                            <option value="1" {% if date_info.is_workday == 1 %}selected{% endif %}>Рабочий (1)</option>
                            <option value="0" {% if date_info.is_workday == 0 %}selected{% endif %}>Нерабочий (0)</option>
                        </select>
                    </td>
                    {% for location in locations %}
                        {% set loc_data = weather_data|selectattr('Локация', 'equalto', location.name)|selectattr('Час', 'equalto', "%02d:00" % hour)|list %}
                        {% if loc_data %}
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="temp" value="{{ loc_data[0]['Температура (°C)'] }}"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="humidity" value="{{ loc_data[0]['Влажность (%)'] }}"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="pressure" value="{{ loc_data[0]['Давление (гПа)'] }}"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="wind" value="{{ loc_data[0]['Скорость ветра (м/с)'] }}"></td>
                        {% else %}
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="temp" value="-"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="humidity" value="-"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="pressure" value="-"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="wind" value="-"></td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .project-container {
        padding: 20px;
        max-width: 100%;
        overflow-x: auto;
    }

    .weather-controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
    }

    .btn-refresh {
        background-color: #2196F3;
        color: white;
    }

    .btn-logout {
        background-color: #f44336;
        color: white;
    }

    .btn-save {
        background-color: #4CAF50;
        color: white;
    }

    .table-container {
        width: 100%;
        overflow-x: auto;
        position: relative;
        margin-bottom: 20px;
    }

    .weather-table {
        border-collapse: collapse;
        min-width: 100%;
    }

    .weather-table th, .weather-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        min-width: 100px;
        box-sizing: border-box;
    }

    .sticky-column {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 2;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .weather-table th {
        position: sticky;
        top: 0;
        background-color: #f2f2f2;
        z-index: 3;
    }

    .weather-table th.sticky-column {
        z-index: 4;
    }

    .editable {
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 3px;
        padding: 3px;
        text-align: center;
        background-color: rgba(255, 255, 255, 0.7);
        box-sizing: border-box;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик сохранения изменений
    document.getElementById('save-changes').addEventListener('click', function() {
        const changes = [];
        // Собираем изменения погоды
        document.querySelectorAll('.editable').forEach(input => {
            const originalValue = input.getAttribute('data-original-value');
            if (originalValue !== input.value) {
                changes.push({
                    type: 'weather',
                    location: input.dataset.location,
                    hour: input.dataset.hour,
                    param: input.dataset.param,
                    value: input.value
                });
            }
        });

        // Собираем изменения рабочих дней
        document.querySelectorAll('.editable-workday').forEach(select => {
            const originalValue = select.getAttribute('data-original-value');
            if (originalValue !== select.value) {
                changes.push({
                    type: 'workday',
                    hour: select.dataset.hour,
                    value: parseInt(select.value)
                });
            }
        });

        if (changes.length > 0) {
            fetch('/save-weather-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ changes: changes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Изменения успешно сохранены!');
                    // Обновляем оригинальные значения
                    document.querySelectorAll('.editable').forEach(input => {
                        input.setAttribute('data-original-value', input.value);
                    });
                    document.querySelectorAll('.editable-workday').forEach(select => {
                        select.setAttribute('data-original-value', select.value);
                    });
                } else {
                    alert('Ошибка при сохранении: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при сохранении изменений');
            });
        } else {
            alert('Нет изменений для сохранения');
        }
    });

    // Инициализация оригинальных значений
    document.querySelectorAll('.editable').forEach(input => {
        input.setAttribute('data-original-value', input.value);
    });
    document.querySelectorAll('.editable-workday').forEach(select => {
        select.setAttribute('data-original-value', select.value);
    });
});
</script>
{% endblock %}