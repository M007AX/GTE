{% extends "base.html" %}

{% block title %}Проект{% endblock %}

{% block content %}
<div class="project-container">
    <div class="nav-menu">
        <a href="{{ url_for('project.project') }}" class="btn btn-nav active">Данные</a>
        <a href="{{ url_for('project.predict') }}" class="btn btn-nav">Прогноз</a>
        <a href="{{ url_for('project.analysis') }}" class="btn btn-nav">Аналитика</a>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-logout">Выйти</a>
    </div>

    <h1>Прогноз на {{ date_info.date }}</h1>
    <p>День недели: {{ date_info.day_of_week }} (0-пн, 6-вс), Неделя года: {{ date_info.week_of_year }}</p>

    <div class="weather-controls">
        <div class="left-controls">
            <a href="{{ url_for('project.project') }}" class="btn btn-refresh">Обновить данные</a>
            <button id="save-changes" class="btn btn-save">Сохранить</button>
            <form action="{{ url_for('project.project') }}" method="post" enctype="multipart/form-data" style="display: inline;">
                <input type="file" name="weather_file" accept=".csv" required>
                <button type="submit" class="btn btn-upload">Загрузить CSV</button>
            </form>
        </div>
    </div>

    <div class="table-container">
        <table class="weather-table">
            <thead>
                <tr>
                    <th class="sticky-column">Час</th>
                    <th style="background-color: #f2f2f2">День недели</th>
                    <th style="background-color: #f2f2f2">Неделя года</th>
                    <th style="background-color: #f2f2f2">Рабочий день</th>
                    {% for location in locations %}
                    <th colspan="4" style="background-color: {{ location.color }}">{{ location.name }}<br>({{ location.coords[0]|round(4) }}°N, {{ location.coords[1]|round(4) }}°E)</th>
                    {% endfor %}
                </tr>
                <tr>
                    <th class="sticky-column"></th>
                    <th style="background-color: #f2f2f2"></th>
                    <th style="background-color: #f2f2f2"></th>
                    <th style="background-color: #f2f2f2"></th>
                    {% for location in locations %}
                    <th style="background-color: {{ location.color }}">Температура (°C)</th>
                    <th style="background-color: {{ location.color }}">Влажность (%)</th>
                    <th style="background-color: {{ location.color }}">Давление (гПа)</th>
                    <th style="background-color: {{ location.color }}">Скорость ветра (м/с)</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hour in range(24) %}
                <tr>
                    <td class="sticky-column">{{ "%02d:00" % hour }}-{{ "%02d:00" % (hour+1) if hour < 23 else "00:00" }}</td>
                    <td style="background-color: #f2f2f2">{{ date_info.day_of_week }}</td>
                    <td style="background-color: #f2f2f2">{{ date_info.week_of_year }}</td>
                    <td style="background-color: #f2f2f2">
                        <select class="editable-workday" data-hour="{{ "%02d:00" % hour }}" style="width: 100%">
                            <option value="1" {% if date_info.is_workday == 1 %}selected{% endif %}>Рабочий (1)</option>
                            <option value="0" {% if date_info.is_workday == 0 %}selected{% endif %}>Нерабочий (0)</option>
                        </select>
                    </td>
                    {% for location in locations %}
                        {% set loc_data = weather_data|selectattr('Локация', 'equalto', location.name)|selectattr('Час', 'equalto', "%02d:00" % hour)|list %}
                        {% if loc_data %}
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="temp" value="{{ loc_data[0]['Температура (°C)'] }}"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="humidity" value="{{ loc_data[0]['Влажность (%)'] }}"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="pressure" value="{{ loc_data[0]['Давление (гПа)'] }}"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="wind" value="{{ loc_data[0]['Скорость ветра (м/с)'] }}"></td>
                        {% else %}
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="temp" value="-"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="humidity" value="-"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="pressure" value="-"></td>
                            <td style="background-color: {{ location.color }}"><input type="text" class="editable" data-location="{{ location.name }}" data-hour="{{ "%02d:00" % hour }}" data-param="wind" value="-"></td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="{{ url_for('static', filename='js/project.js') }}"></script>

<style>
    .nav-menu {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }

    .btn-nav {
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s;
        background-color: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
    }

    .btn-nav:hover {
        background-color: #e9ecef;
    }

    .btn-nav.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .btn-logout {
        margin-left: auto;
        background-color: #dc3545;
        color: white;
    }

    .btn-logout:hover {
        background-color: #c82333;
    }

    .weather-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .left-controls {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .btn-refresh {
        background-color: #6c757d;
        color: white;
    }

    .btn-refresh:hover {
        background-color: #5a6268;
    }

    .btn-save {
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
    }

    .btn-save:hover {
        background-color: #218838;
    }

    .btn-upload {
        background-color: #17a2b8;
        color: white;
        border: none;
        cursor: pointer;
    }

    .btn-upload:hover {
        background-color: #138496;
    }

    .table-container {
        overflow-x: auto;
    }

    .weather-table {
        width: 100%;
        border-collapse: collapse;
    }

    .weather-table th, .weather-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
    }

    .weather-table th {
        background-color: #f2f2f2;
        position: sticky;
        top: 0;
    }

    .sticky-column {
        position: sticky;
        left: 0;
        background-color: #f8f9fa;
        z-index: 1;
    }
</style>
{% endblock %}