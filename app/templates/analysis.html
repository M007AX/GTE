{% extends "base.html" %}

{% block title %}Анализ прогноза{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles_analysis.css') }}">
{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Навигационное меню с поддержкой дат -->
    <div class="nav-menu">
        <a href="{{ url_for('project.project', date_str=date_info.date.replace('.', '-')) }}" class="btn btn-nav">Данные</a>
        <a href="{{ url_for('project.predict', date_str=date_info.date.replace('.', '-')) }}" class="btn btn-nav">Прогноз</a>
        <a href="{{ url_for('project.analysis', date_str=date_info.date.replace('.', '-')) }}" class="btn btn-nav active">Аналитика</a>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-logout">Выйти</a>
    </div>

    <h1>Анализ прогноза на {{ date_info.date }}</h1>
    <p>День недели: {{ date_info.day_of_week }} (0-пн, 6-вс), Неделя года: {{ date_info.week_of_year }}</p>

    <!-- Форма загрузки данных с указанием даты -->
    <div class="upload-section">
        <form action="{{ url_for('project.analysis', date_str=date_info.date.replace('.', '-')) }}" method="post" enctype="multipart/form-data">
            <input type="file" name="fact_file" accept=".csv" required>
            <button type="submit" class="btn btn-upload">Загрузить фактические данные (CSV)</button>
        </form>
    </div>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if not predicted %}
        <div class="alert alert-info">
            Нет данных прогноза для этой даты. Сначала создайте прогноз на странице "Прогноз".
        </div>
    {% elif not actual %}
        <div class="alert alert-info">
            Нет фактических данных для этой даты. Загрузите CSV файл с фактическими данными.
        </div>
    {% else %}
        {% if metrics %}
        <!-- Блок с метриками качества -->
        <div class="metrics-section">
            <h2>Метрики качества прогноза</h2>
            <table class="metrics-table">
                <tr>
                    <th>Метрика</th>
                    <th>Значение</th>
                </tr>
                <tr>
                    <td>Средняя абсолютная ошибка (MAE)</td>
                    <td>{{ "%.2f"|format(metrics.mae) }} кВт·ч</td>
                </tr>
                <tr>
                    <td>Среднеквадратичная ошибка (RMSE)</td>
                    <td>{{ "%.2f"|format(metrics.rmse) }} кВт·ч</td>
                </tr>
                <tr>
                    <td>Коэффициент детерминации (R²)</td>
                    <td>{{ "%.4f"|format(metrics.r2) }}</td>
                </tr>
                <tr>
                    <td>Взвешенная абсолютная ошибка (WAPE)</td>
                    <td>{{ "%.2f"|format(metrics.wape) }}%</td>
                </tr>
            </table>
        </div>
        {% endif %}

        {% if combined_data %}
        <!-- Таблица сравнения прогноза и факта -->
        <div class="comparison-section">
            <h2>Почасовое сравнение</h2>
            <div class="table-container">
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Временной интервал</th>
                            <th>Прогноз (кВт·ч)</th>
                            <th>Факт (кВт·ч)</th>
                            <th>Разница (кВт·ч)</th>
                            <th>Отклонение (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in combined_data %}
                        <tr>
                            <td>{{ "%02d:00-%02d:00"|format(item.hour, (item.hour + 1)%24) }}</td>
                            <td>{{ "%.2f"|format(item.prediction) }}</td>
                            <td>{{ "%.2f"|format(item.actual) }}</td>
                            <td class="{{ 'positive' if item.difference > 0 else 'negative' }}">
                                {{ "%+.2f"|format(item.difference) }}
                            </td>
                            <td class="{{ 'positive' if item.percentage_diff > 0 else 'negative' }}">
                                {{ "%+.2f"|format(item.percentage_diff) }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- График сравнения -->
        <div class="chart-section">
            <h2>График сравнения прогноза и факта</h2>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        {% endif %}
    {% endif %}
</div>

{% if predicted and actual %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('comparisonChart').getContext('2d');

    // Данные для графика
    const predictedData = [
        {% for item in combined_data %}
        {{ item.prediction }},
        {% endfor %}
    ];

    const actualData = [
        {% for item in combined_data %}
        {{ item.actual }},
        {% endfor %}
    ];

    // Создаем график
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => i),
            datasets: [
                {
                    label: 'Прогноз',
                    data: predictedData,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Факт',
                    data: actualData,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Потребление (кВт·ч)'
                    }
                },
                x: {
                    type: 'linear',
                    offset: true,
                    ticks: {
                        stepSize: 1,
                        autoSkip: false,
                        callback: function(value) {
                            if (value === -0.5) return '0';
                            if (value === 23.5) return '0';
                            if (Number.isInteger(value - 0.5) && value >= 0.5 && value < 23.5) {
                                return (value - 0.5) + 1;
                            }
                            return null;
                        }
                    },
                    grid: {
                        offset: false
                    },
                    min: -0.5,
                    max: 23.5,
                    title: {
                        display: true,
                        text: 'Часы'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const hour = context[0].dataIndex;
                            const prev_hour = hour % 24;
                            const current_hour = (hour + 1) % 24;
                            return `${prev_hour.toString().padStart(2, '0')}:00-${current_hour.toString().padStart(2, '0')}:00`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw.toFixed(2)} кВт·ч`;
                        }
                    }
                }
            },
            barPercentage: 0.9,
            categoryPercentage: 0.9
        }
    });
});
</script>
{% endif %}
{% endblock %}